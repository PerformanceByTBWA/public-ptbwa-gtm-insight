___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "public-ptbwa-gtm-insight",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Ptbwa Insight Pixel",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true,
    "help": "Addirect에서 발급받은 Pixel ID를 입력하세요.",
    "notSetText": "Pixel ID는 필수값 입니다."
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "이벤트 유형",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "page_view",
        "displayValue": "페이지뷰"
      },
      {
        "value": "click",
        "displayValue": "클릭"
      },
      {
        "value": "scroll",
        "displayValue": "페이지스크롤"
      },
      {
        "value": "conversion",
        "displayValue": "전환"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "scrollDepth",
    "displayName": "스크롤 좌표 Value",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NUMBER"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "scroll",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "clickedId",
    "displayName": "Click ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "click",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "conversionType",
    "displayName": "전환유형",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "order",
        "displayValue": "주문"
      },
      {
        "value": "purchase",
        "displayValue": "구매"
      },
      {
        "value": "signup",
        "displayValue": "회원가입"
      },
      {
        "value": "signin",
        "displayValue": "로그인"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionValue",
    "displayName": "전환값",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "conversionType",
        "paramValue": "purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "conversionType",
        "paramValue": "order",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionMeta",
    "displayName": "전환 Meta Data",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const generateRandom = require('generateRandom');
const getTimestampMillis = require('getTimestampMillis');
const sendPixel = require('sendPixel');
const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');

const COOKIE_NAME = '_insight_uid';
const GA_COOKIE = '_ga';
const PIXEL_ENDPOINT = 'https://cs.ptbwa.com/v1/';


function createUuid() {
  const hex = '0123456789abcdef';
  const sections = [8, 4, 4, 4, 12];
  let uuid = '';
  for (let i = 0; i < sections.length; i++) {
    if (i > 0) uuid += '-';
    for (let j = 0; j < sections[i]; j++) {
      // generateRandom(min, max) returns a float between min (inclusive) and max (exclusive)
      const index = generateRandom(0, 16); 
      uuid += hex.charAt(index | 0); // bitwise OR 0 is allowed, acts like Math.floor
    }
  }
  return uuid;
}



function getOrCreateUid(cookieName) {
  // log('== cookieName : ');
  // log(getCookieValues(cookieName));
      
  let uid = getCookieValues(cookieName)[0];
  if (!uid) uid = createUuid();
  // log('setCookie : ', uid);
  setCookie(cookieName, uid, {
    'max-age': 60 * 60 * 24 * 30, // 30일
    'secure': true
  });
  return uid;
}


function serialize(params) {
  var query = '';
  for (var key in params) {
    if (params.hasOwnProperty(key)) {
      if (query.length > 0) query += '&';
      query += key + '=' + encodeUriComponent(params[key] || '');
    }
  }
  return query;
}

(function () {
  const userId = getOrCreateUid(COOKIE_NAME);
  const gaId = getCookieValues(GA_COOKIE)[0] || '';
  const timestamp = getTimestampMillis();
  
  const payload = {
    pid: data.pixelId,
    eid: createUuid(),
    ev: data.eventType,
    scroll: data.scrollDepth,
    click: data.clickedId,
    conv_type: data.conversionType,
    conv_value: data.conversionValue,
    conv_meta: data.conversionMeta ? JSON.stringify(data.conversionMeta) : '',
    cid: userId,
    gid: gaId,
    url: getUrl(),
    ref: getReferrerUrl(),
    ts: timestamp
  };

  
  const pixelUrl = PIXEL_ENDPOINT + '?' + serialize(payload);
  // log(pixelUrl);
  /*  
  sendPixel(pixelUrl, data.gtmOnSuccess, data.gtmOnFailure);
  if (data.gtmOnSuccess) {
      data.gtmOnSuccess();
  }
  */
  sendPixel(pixelUrl, null, null);
  if (data.gtmOnSuccess) data.gtmOnSuccess();
  else data.gtmOnFailure();
})();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cs.ptbwa.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_insight_uid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[PTBWA] gtmOnSuccess is invoked on sendPixel success'
  code: "// test that gtmOnSuccess() is called when sendPixel succeeds\nmock('sendPixel',\
    \ function(url, onSuccess, onFailure) {\n  if (typeof onSuccess == 'function')\
    \ {\n    onSuccess();\n  }\n});\n\nconst mockData = {\n    pixelId: _pixelID,\n\
    \    eventType: 'page_view' \n};\nrunCode(mockData);\n\n// Verify that the tag\
    \ finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: '[PTBWA] gtmOnFailure is invoked when sendPixel fails'
  code: "// test gtmOnFailure() is called when sendPixel fails\nmock('sendPixel',\
    \ function(url, onSuccess, onFailure) {\n  if (typeof onFailure == 'function')\
    \ {\n    onFailure();\n  }\n});\n\nconst mockData = {\n    pixelId: _pixelID,\n\
    \    eventType: 'page_view' \n};\nrunCode(mockData);\n\n// Verify onFailure was\
    \ called\nassertApi('gtmOnFailure').wasCalled();"
- name: '[PTBWA] Page View'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'page_view'
    };
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=page_view');
    assertApi('gtmOnSuccess').wasCalled();
- name: '[PTBWA] Conversion Purchase event is serialized and sent'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'purchase',
      conversionType: 'purchase',
      conversionValue: '49.99',
      // conversionMeta: '{"coupon":"NEW50"}'
    };
    runCode(mockData);


    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=purchase');
    assertThat(mockUrl[0]).contains('conv_type=purchase');
    assertThat(mockUrl[0]).contains('conv_value=49.99');
    // assertThat(mockUrl[0]).contains('conv_meta=%7B%22coupon%22%3A%22NEW50%22%7D');
- name: '[PTBWA] Conversion Order event is serialized and sent'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'order',
      conversionType: 'order',
      conversionValue: '49.99',
      // conversionMeta: '{"coupon":"NEW50"}'
    };
    runCode(mockData);


    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=order');
    assertThat(mockUrl[0]).contains('conv_type=order');
    assertThat(mockUrl[0]).contains('conv_value=49.99');
    // assertThat(mockUrl[0]).contains('conv_meta=%7B%22coupon%22%3A%22NEW50%22%7D');
- name: '[PTBWA] Cookie is set when not exists'
  code: |-
    var mockUrl = [];
    mock('setCookie', () => {});
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: 'abc123',
      eventType: 'scroll',
      scrollDepth: '80'
    };
    runCode(mockData);

    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=scroll');
    assertThat(mockUrl[0]).contains('scroll=80');
setup: "const _pixelID = 'sk_123456789012345678901234567890123';\n\n// Need to be\
  \ mocked to fix the UUID\nmock('generateRandom', 1);\nmock('getTimestampMillis',\
  \ 1);\nmock('getUrl', 'ptbwa.com');\nmock('getReferrerUrl', 'clien.net');\n\nmock('getCookieValues',\
  \ () => []); \nmock('setCookie', () => {});"


___NOTES___

Created on 2025. 12. 4. 오후 3:07:23


