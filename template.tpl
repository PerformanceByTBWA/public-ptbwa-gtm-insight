___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Ptbwa Insight Pixel",
  "categories": ["ADVERTISING", "ANALYTICS"],
  "brand": {
    "id": "ptbwa_insight_pixel",
    "displayName": "Ptbwa Insight Pixel",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Ptbwa Insight Pixel",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true,
    "help": "Addirect에서 발급받은 Pixel ID를 입력하세요.",
    "notSetText": "Pixel ID는 필수값 입니다."
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "이벤트 유형",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "page_view",
        "displayValue": "페이지뷰"
      },
      {
        "value": "click",
        "displayValue": "클릭"
      },
      {
        "value": "scroll",
        "displayValue": "페이지스크롤"
      },
      {
        "value": "conversion",
        "displayValue": "전환"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "scrollDepth",
    "displayName": "스크롤 좌표 Value",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NUMBER"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "scroll",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "clickedId",
    "displayName": "Click ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "click",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "conversionType",
    "displayName": "전환유형",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "order",
        "displayValue": "주문"
      },
      {
        "value": "purchase",
        "displayValue": "구매"
      },
      {
        "value": "signup",
        "displayValue": "회원가입"
      },
      {
        "value": "signin",
        "displayValue": "로그인"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionValue",
    "displayName": "전환값",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "conversionType",
        "paramValue": "purchase",
        "type": "EQUALS"
      },
      {
        "paramName": "conversionType",
        "paramValue": "order",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionMeta",
    "displayName": "전환 Meta Data",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const generateRandom = require('generateRandom');
const getTimestampMillis = require('getTimestampMillis');
const sendPixel = require('sendPixel');
const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');

const COOKIE_NAME = '_insight_uid';
const GA_COOKIE = '_ga';
const PIXEL_ENDPOINT = 'https://cs.ptbwa.com/v1/';


function createUuid() {
  const hex = '0123456789abcdef';
  const sections = [8, 4, 4, 4, 12];
  let uuid = '';
  for (let i = 0; i < sections.length; i++) {
    if (i > 0) uuid += '-';
    for (let j = 0; j < sections[i]; j++) {
      // generateRandom(min, max) returns a float between min (inclusive) and max (exclusive)
      const index = generateRandom(0, 16); 
      uuid += hex.charAt(index | 0); // bitwise OR 0 is allowed, acts like Math.floor
    }
  }
  return uuid;
}



function getOrCreateUid(cookieName) {
  // log('== cookieName : ');
  // log(getCookieValues(cookieName));
      
  let uid = getCookieValues(cookieName)[0];
  if (!uid) uid = createUuid();
  // log('setCookie : ', uid);
  setCookie(cookieName, uid, {
    'max-age': 60 * 60 * 24 * 30, // 30일
    'secure': true
  });
  return uid;
}


function serialize(params) {
  var query = '';
  for (var key in params) {
    if (params.hasOwnProperty(key)) {
      if (query.length > 0) query += '&';
      query += key + '=' + encodeUriComponent(params[key] || '');
    }
  }
  return query;
}

(function () {
  const userId = getOrCreateUid(COOKIE_NAME);
  const gaId = getCookieValues(GA_COOKIE)[0] || '';
  const timestamp = getTimestampMillis();
  
  const payload = {
    pid: data.pixelId,
    eid: createUuid(),
    ev: data.eventType,
    scroll: data.scrollDepth,
    click: data.clickedId,
    conv_type: data.conversionType,
    conv_value: data.conversionValue,
    // conv_meta: data.conversionMeta ? JSON.stringify(data.conversionMeta) : '',
    conv_meta: data.conversionMeta || '',
    cid: userId,
    gid: gaId,
    url: getUrl(),
    ref: getReferrerUrl(),
    ts: timestamp
  };

  
  const pixelUrl = PIXEL_ENDPOINT + '?' + serialize(payload);
  // log(pixelUrl);
  /*  
  sendPixel(pixelUrl, data.gtmOnSuccess, data.gtmOnFailure);
  if (data.gtmOnSuccess) {
      data.gtmOnSuccess();
  }
  */
  sendPixel(pixelUrl, data.gtmOnSuccess, data.gtmOnFailure);
  if (data.gtmOnSuccess) {
    data.gtmOnSuccess();
  }else{
    data.gtmOnFailure();
  }
})();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cs.ptbwa.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_insight_uid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[PTBWA] gtmOnSuccess is invoked on sendPixel success'
  code: "// test that gtmOnSuccess() is called when sendPixel succeeds\nmock('sendPixel',\
    \ function(url, onSuccess, onFailure) {\n  if (typeof onSuccess == 'function')\
    \ {\n    onSuccess();\n  }\n});\n\nconst mockData = {\n    pixelId: _pixelID,\n\
    \    eventType: 'page_view' \n};\nrunCode(mockData);\n\n// Verify that the tag\
    \ finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: '[PTBWA] gtmOnFailure is invoked when sendPixel fails'
  code: "// test gtmOnFailure() is called when sendPixel fails\nmock('sendPixel',\
    \ function(url, onSuccess, onFailure) {\n  if (typeof onFailure == 'function')\
    \ {\n    onFailure();\n  }\n});\n\nconst mockData = {\n    pixelId: _pixelID,\n\
    \    eventType: 'page_view' \n};\nrunCode(mockData);\n\n// Verify onFailure was\
    \ called\nassertApi('gtmOnFailure').wasCalled();"
- name: '[PTBWA] Page View'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'page_view'
    };
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=page_view');
    assertApi('gtmOnSuccess').wasCalled();
- name: '[PTBWA] Conversion Purchase event is serialized and sent'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'purchase',
      conversionType: 'purchase',
      conversionValue: '49.99',
      // conversionMeta: '{"coupon":"NEW50"}'
    };
    runCode(mockData);


    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=purchase');
    assertThat(mockUrl[0]).contains('conv_type=purchase');
    assertThat(mockUrl[0]).contains('conv_value=49.99');
    // assertThat(mockUrl[0]).contains('conv_meta=%7B%22coupon%22%3A%22NEW50%22%7D');
- name: '[PTBWA] Conversion Order event is serialized and sent'
  code: |-
    var mockUrl = [];
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: _pixelID,
      eventType: 'order',
      conversionType: 'order',
      conversionValue: '49.99',
      conversionMeta: '{"coupon":"NEW50"}'
    };
    runCode(mockData);


    assertApi('sendPixel').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=order');
    assertThat(mockUrl[0]).contains('conv_type=order');
    assertThat(mockUrl[0]).contains('conv_value=49.99');
    assertThat(mockUrl[0]).contains('conv_meta=%7B%22coupon%22%3A%22NEW50%22%7D');
- name: '[PTBWA] Cookie is set when not exists'
  code: |-
    var mockUrl = [];
    mock('setCookie', () => {});
    mock('sendPixel', function(url, onSuccess, onFailure) {
      mockUrl.push(url);
      if (typeof onSuccess == 'function') {
        onSuccess();
      }
    });

    const mockData = {
      pixelId: 'abc123',
      eventType: 'scroll',
      scrollDepth: '80'
    };
    runCode(mockData);

    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(mockUrl[0]).contains('ev=scroll');
    assertThat(mockUrl[0]).contains('scroll=80');
setup: "const _pixelID = 'sk_123456789012345678901234567890123';\n\n// Need to be\
  \ mocked to fix the UUID\nmock('generateRandom', 1);\nmock('getTimestampMillis',\
  \ 1);\nmock('getUrl', 'ptbwa.com');\nmock('getReferrerUrl', 'clien.net');\n\nmock('getCookieValues',\
  \ () => []); \nmock('setCookie', () => {});"


___NOTES___

Created on 2025. 12. 4. 오후 3:07:23


